<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ููุญุฉ ุชุญูู ุงูุจูุฏูุฉ</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
<div class="bg-gray-100 font-sans">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 text-white p-6">
      <h2 class="text-2xl font-bold mb-6">ููุญุฉ ุชุญูู ุงูุจูุฏูุฉ</h2>
      <nav>
        <p style="text-align: center;">ูุฑุญุจูุงุ <span  id="adminName">Admin</span> ๐</p><br>

        <button onclick="render('citizens')" class="block w-full text-left py-2 px-4 hover:bg-gray-700 rounded transition">ุฅุฏุงุฑุฉ ุงูููุงุทููู๐ชช</button>
        <button onclick="render('documents')" class="block w-full text-left py-2 px-4 hover:bg-gray-700 rounded transition">ุฅุฏุงุฑุฉ ุงููุซุงุฆู๐</button>
        <button onclick="render('requests')" class="block w-full text-left py-2 px-4 hover:bg-gray-700 rounded transition">ุฅุฏุงุฑุฉ ุงูุทูุจุงุช๐</button>
        <button onclick="render('settings')" class="block w-full text-left py-2 px-4 hover:bg-gray-700 rounded transition">ุงูุฅุนุฏุงุฏุงุชโ</button>
      </nav>
      <br>
      <button onclick="logOut()" class="mt-auto w-full bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700 transition">ุชุณุฌูู ุงูุฎุฑูุฌ&nbsp   โป</button>
    </aside>
    <!-- Main Content -->
    <main class="flex-1 p-8 overflow-auto">
      <div id="main-content"></div>
    </main>
  </div>
  <!-- Add Citizen Modal -->
  <div id="addCitizenModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white p-8 rounded-lg w-96">
      <h3 class="text-xl font-bold mb-4">ุฅุถุงูุฉ ููุงุทู ุฌุฏูุฏ</h3>
      <form id="addCitizenForm" class="space-y-4">
        <div>
          <label for="fullName" class="block mb-1">ุงูุงุณู ุงููุงูู:</label>
          <input type="text" id="fullName" name="fullName" required class="w-full p-2 border rounded">
        </div>
        <div>
        <label class="block mb-2">ููุน ุงููุซููุฉ:</label>
        <select id="role" class="w-full p-2 border rounded">
            <option value="admin">admin</option>
            <option value="citizen">citizen</option>
        </select>
        </div>
        <div>
          <label for="city" class="block mb-1">ุงููุฏููุฉ :</label>
          <input type="text" id="city" name="city" required class="w-full p-2 border rounded bg-gray-100">
        </div>
        <div>
          <label for="birth" class="block mb-1">ุชุงุฑูุฎ ุงููููุงุฏ :</label>
          <input type="date" id="birth" name="birth" required class="w-full p-2 border rounded bg-gray-100">
        </div>
        <div>
          <label for="email" class="block mb-1">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:</label>
          <input type="email" id="email" name="email" required class="w-full p-2 border rounded">
        </div>
        <div>
          <label for="password" class="block mb-1">ูููุฉ ุงููุฑูุฑ:</label>
          <input type="password" id="password" name="password" required class="w-full p-2 border rounded">
        </div>
        <div>
          <label for="walletAddress" class="block mb-1">ุนููุงู ุงููุญูุธุฉ:</label>
          <input type="text" id="walletAddress" name="walletAddress" readonly class="w-full p-2 border rounded bg-gray-100">
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition">ุฅูุบุงุก</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">ุฅุถุงูุฉ ุงูููุงุทู</button>
        </div>

    </div>
  </div>
</div>
  <script>
  document.getElementById('addCitizenForm').addEventListener('submit', function(event) {
  event.preventDefault(); // ูููุน ุฅุฑุณุงู ุงููููุฐุฌ ุจุงูุทุฑููุฉ ุงูุชูููุฏูุฉ

  // ุชูููุฏ ุนููุงู ุงููุญูุธุฉ
  const randomWallet = '0x' + Math.random().toString(16).substr(2, 40);
  document.getElementById('walletAddress').value = randomWallet;

  // ุฌูุน ุงูุจูุงูุงุช ูู ุงููููุฐุฌ
  const citizenData = {
    fullName: document.getElementById('fullName').value,

    email: document.getElementById('email').value,
    password: document.getElementById('password').value,
    city: document.getElementById('city').value,
    birth: document.getElementById('birth').value,
    role: document.getElementById('role').value,
    walletAddress: randomWallet
  };

  // ุฅุฑุณุงู ุงูุจูุงูุงุช ุฅูู ุงูุฎุงุฏู ุจุงุณุชุฎุฏุงู fetch
  fetch('http://localhost:5000/api/auth/register', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(citizenData),
  })
  .then(response => response.json())
  .then(data => {
    if (data.message === 'ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญ') {
      alert('ุชู ุฅุถุงูุฉ ุงูููุงุทู ุจูุฌุงุญ');
     closeModal(); // ุฅุบูุงู ุงููุงูุฐุฉ ุจุนุฏ ุงูุฅุถุงูุฉ
     location.reload();
    } else {
      if (data.error && data.error.code === 11000) {
        alert('ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุฌูุฏ ุจุงููุนู!');
      } else {
        alert('ูุดู ูู ุฅุถุงูุฉ ุงูููุงุทู');
      }

    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุถุงูุฉ ุงูููุงุทู');
  });
});

  </script>
  <!-- Confirm Delete Modal -->
  <div id="confirmDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white p-8 rounded-lg w-96">
      <h3 class="text-xl font-bold mb-4">ุชุฃููุฏ ุงูุญุฐู</h3>
      <p class="mb-4">ูู ุฃูุช ูุชุฃูุฏ ูู ุฃูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงูููุงุทูุ</p>
      <div class="flex justify-end space-x-2">
        <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition">ูุง</button>
        <button onclick="deleteCitizen()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">ูุนู</button>
      </div>
    </div>
  </div>
  <script>
    // Dashboard functionality
    const dashboard = {
      logOut() {
        localStorage.removeItem('token');
        localStorage.removeItem('userId');
        window.location.href = 'login-admin.html';
      },

      openModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
        document.getElementById(modalId).classList.add('flex');
      },

      closeModal(modalId) {
        document.getElementById(modalId).classList.remove('flex');
        document.getElementById(modalId).classList.add('hidden');
      },

      render(section) {
        const content = {
          citizens: `
            <h3 class="text-2xl font-bold mb-4">๐คุฅุฏุงุฑุฉ ุงูููุงุทููู</h3>
            <button onclick="dashboard.openModal('addCitizenModal')" class="mb-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">ุฅุถุงูุฉ ููุงุทู ุฌุฏูุฏ</button>
            <div>
              <input type="text" id="searchCitizens" placeholder="ุจุญุซ ุนู ุงูููุงุทู" onkeyup="dashboard.searchCitizens()" class="w-full p-2 mb-4 border rounded">
              <table id="citizensTable" class="w-full border-collapse">
                <thead>
                  <tr class="bg-gray-200">
                    <th class="p-2 text-right">ุงูุงุณู</th>
                    <th class="p-2 text-right">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</th>
                    <th class="p-2 text-right">ุนููุงู ุงููุญูุธุฉ</th>
                    <th class="p-2 text-right">ุงููุฏููุฉ </th>
                    <th class="p-2 text-right">ุชุงุฑูุฎ ุงููููุงุฏ </th>
                    <th class="p-2 text-right">ุงูุฏูุฑ</th>
                    <th class="p-2 text-right">ุงูุฅุฌุฑุงุกุงุช</th>
                  </tr>
                </thead>
                <tbody >

                </tbody>
              </table>
            </div>
          `,
          documents: `
            <h3 class="text-2xl font-bold mb-4">๐ุฅุฏุงุฑุฉ ุงููุซุงุฆู</h3>
<!-- ุฒุฑ ุฅุตุฏุงุฑ ูุซููุฉ -->
<button onclick="openModal1()" class="mb-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
    ุฅุตุฏุงุฑ ูุซููุฉ ุฌุฏูุฏุฉ
</button>
    <input type="text" id="searchd" placeholder="ุจุญุซ ุนู ูุซููุฉ ุนุจุฑ ุนููุงู ุงููุญูุธุฉ"
onkeyup="dashboard.searchd()" class="w-full p-2 mb-4 border rounded">

<!-- ูููุฐุฌ (Modal) ุฅุถุงูุฉ ูุซููุฉ -->
<div id="documentModall" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96">
        <h2 class="text-xl font-semibold mb-4">ุฅุตุฏุงุฑ ูุซููุฉ ุฌุฏูุฏุฉ</h2>

        <!-- ุญูู ุงุฎุชูุงุฑ ููุน ุงููุซููุฉ -->
        <label class="block mb-2">ููุน ุงููุซููุฉ:</label>
        <select id="documentType" class="w-full p-2 border rounded">
            <option value="ุดูุงุฏุฉ ูููุงุฏ">ุดูุงุฏุฉ ูููุงุฏ</option>
            <option value="ุดูุงุฏุฉ ุฅูุงูุฉ">ุดูุงุฏุฉ ุฅูุงูุฉ</option>
            <option value="ุชุตุฑูุญ ุดุฑูู">ุชุตุฑูุญ ุดุฑูู</option>
            <option value="ุดูุงุฏุฉ ุนูู">ุดูุงุฏุฉ ุนูู</option>
        </select>

        <!-- ุญูู ุงุฎุชูุงุฑ ุงุณู ุงูููุงุทู -->
        <label class="block mt-4 mb-2">ุงุณู ุงูููุงุทู:</label>
        <input type="text" id="citizenFullName" class="w-full p-2 border rounded" placeholder="ุฃุฏุฎู ุงุณู ุงูููุงุทู" onfocus="loadCitizensList()" readonly>

        <!-- ูุงุฆูุฉ ุงูููุงุทููู ุงูุชู ุณุชุธูุฑ ุนูุฏ ุงูุถุบุท ูู ุญูู ุงุณู ุงูููุงุทู -->
        <div id="citizenList" class="absolute w-full mt-1 bg-white border rounded shadow-lg hidden">
            <!-- ุณูุชู ููุคูุง ุนุจุฑ JavaScript -->
        </div>
 <label for="documentFile">ุฑูุน ููู ุงููุซููุฉ (PDF ููุท):</label>
    <input type="file" id="documentFile" name="documentFile" accept="application/pdf" required>

        <!-- ุญูู ุฑูู ูููุฉ ุงูููุงุทู (ุณูุชู ููุคู ุชููุงุฆููุง ุนูุฏ ุงุฎุชูุงุฑ ุงูููุงุทู) -->
        <label class="block mt-4 mb-2">ุฑูู ูููุฉ ุงูููุงุทู:</label>
        <input type="text" id="citizenId" class="w-full p-2 border rounded" placeholder="ุฑูู ูููุฉ ุงูููุงุทู" readonly>

        <div class="flex justify-between mt-4">
            <button onclick="issueDocument()" class="bg-blue-600 text-white px-4 py-2 rounded">ุฅุตุฏุงุฑ</button>
            <button onclick="closeModal1()" class="bg-red-600 text-white px-4 py-2 rounded">ุฅุบูุงู</button>
        </div>
    </div>
</div>



</div>
<table id="documentsTable" class="w-full border-collapse">
    <thead>
        <tr class="bg-gray-200">
            <th class="p-2 text-right">ููุน ุงููุซููุฉ</th>
            <th class="p-2 text-right">ุตุงุญุจ ุงููุซููุฉ</th>
            <th class="p-2 text-right"> ุนููุงู ุงููุญูุธุฉ	 </th>
            <th class="p-2 text-right">ุงูุฅุฌุฑุงุกุงุช</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

          `,
          requests: `
          <h3 class="text-2xl font-bold mb-4">๐ุฅุดุนุงุฑุงุช๐</h3>

<table class="w-full border-collapse">
  <thead>
    <tr class="bg-gray-200">

    </tr>
  </thead>
  <tbody  id="req">

  </tbody>
</table>
 `,
          settings: `
     <h3 class="text-2xl font-bold mb-4">ุงูุฅุนุฏุงุฏุงุช</h3>
<div class="space-y-4">
  <div>
    <label for="currentPassword" class="block mb-2">ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ</label>
    <input type="password" id="currentPassword" class=" p-2 border rounded" >
  </div>
  <div>
    <label for="newPassword" class="block mb-2">ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
    <input type="password" id="newPassword" class=" p-2 border rounded" >
  </div>
  <div>
    <label for="confirmNewPassword" class="block mb-2">ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
    <input type="password" id="confirmNewPassword" class=" p-2 border rounded" >
  </div>
  <div>
    <button id="changePasswordBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition" onclick="changePassword()">ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</button>
  </div>
</div>
`,
        };

        document.getElementById('main-content').innerHTML = content[section];
      },

      sendDocument(id) {
        alert(`ุชู ุฅุฑุณุงู ุงููุซููุฉ ${id}`);
      },

      deleteCitizen() {
        alert('ุชู ุญุฐู ุงูููุงุทู');
        dashboard.closeModal('confirmDeleteModal');
      },

      searchCitizens() {
        const query = document.getElementById('searchCitizens').value.toLowerCase();
        const rows = document.querySelectorAll('#citizensTable tbody tr');
        rows.forEach(row => {
          const name = row.cells[0].textContent.toLowerCase();
          if (name.includes(query)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      }
 };
    dashboard.render('citizens');
        // Global function aliases
        function render(section) { dashboard.render(section); }
    function logOut() { dashboard.logOut(); }
    function openModal(modalId) { dashboard.openModal(modalId); }
    function closeModal() { dashboard.closeModal('addCitizenModal'); }
    function closeDeleteModal() { dashboard.closeModal('confirmDeleteModal'); }

  </script>
<script>
 function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
    const userId = localStorage.getItem('userId'); // ุงุณุชุฑุฌุงุน userId ูู localStorage

    if (!userId) {
        alert('ุชุนุฐุฑ ุงูุนุซูุฑ ุนูู ูุนุฑู ุงููุณุชุฎุฏูุ ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู!');
        return;
    }

    if (!currentPassword || !newPassword || !confirmNewPassword) {
        alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู!');
        return;
    }

    if (newPassword !== confirmNewPassword) {
        alert('ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ ูุชุฃููุฏูุง ุบูุฑ ูุชุทุงุจููู!');
        return;
    }

    fetch('http://localhost:5000/api/auth/change-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, currentPassword, newPassword })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
        } else {
            alert(data.message); // ุนุฑุถ ุฑุณุงูุฉ ุงูุฎุทุฃ
        }
    })
    .catch(error => {
        console.error('ุฎุทุฃ ูู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุบููุฑ ูููุฉ ุงููุฑูุฑ!');
    });
}
  </script>
  <script >
      // ุงูุชุฃูุฏ ูู ุฃู ุงูุนูุตุฑ ููุฌูุฏ ูู DOM ูุจู ุชูููุฐ ุงูููุฏ
      fetch('http://localhost:5000/api/auth/citizens')
      .then(response => response.json())
      .then(data => {
        const citizensTable = document.querySelector('#citizensTable tbody');
        citizensTable.innerHTML = ''; // ุชูุฑูุบ ุงูุฌุฏูู ูุจู ุฅุถุงูุฉ ุงูุจูุงูุงุช
        data.forEach((citizen) => {
          const row = `<tr>
            <td class='p-2 border'>${citizen.fullName}</td>
            <td class='p-2 border'>${citizen.email}</td>
            <td class='p-2 border'>${citizen.walletAddress}</td>
            <td class='p-2 border'>${citizen.city}</td>
            <td class='p-2 border'>${citizen.birth}</td>
            <td class='p-2 border'>${citizen.role}</td>
            <td class='p-2 border'>
              <button class='px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition' onclick='deleteCitizen("${citizen._id}")'>ุญุฐู</button>
              <button class='px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition' onclick='viewDocuments("${citizen._id}")'>ุนุฑุถ ุงููุซุงุฆู</button>

              </td>
          </tr>`;
          citizensTable.innerHTML += row;
        });
      })
      .catch(error => console.error('Error fetching citizens:', error));

      function deleteCitizen(id) {
  if (!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุฃูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงูููุงุทูุ")) {
    return;
  }

  fetch(`http://localhost:5000/api/auth/citizens/${id}`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    alert(data.message); // ุฅุธูุงุฑ ุฑุณุงูุฉ ุงููุฌุงุญ ุฃู ุงูุฎุทุฃ
    location.reload(); // ุชุญุฏูุซ ุงููุงุฆูุฉ ุจุนุฏ ุงูุญุฐู
  })
  .catch(error => console.error('Error deleting citizen:', error));
}

function deleteDocument(documentId) {
                  fetch(`http://localhost:5000/api/documents/${documentId}`, {
                    method: 'DELETE',
                  })
                    .then(response => response.json())
                    .then(data => {
                      alert('ุชู ุญุฐู ุงููุซููุฉ');
                      // ุชุญุฏูุซ ุงูุฌุฏูู ุจุนุฏ ุงูุญุฐู
                      render('documents'); // ุฅุนุงุฏุฉ ุชุญููู ุงููุซุงุฆู
                    })
                    .catch(error => {
                      console.error('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญุฐู:', error);
                      alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงููุซููุฉ');
                    });
                }
     // ุฏุงูุฉ ุฅุฑุณุงู ุงููุซููุฉ
     function sendDocument(documentId) {
                        // ููููู ุชุฎุตูุต ูุธููุฉ ุฅุฑุณุงู ุงููุซููุฉ ููุง
                        alert(`ุฅุฑุณุงู ุงููุซููุฉ ID: ${documentId}`);
                        // ุฅุฑุณุงู ุงููุซููุฉ ุฅูู ุงูุฌูุฉ ุงููุนููุฉ
                      }
function deleteRequest(requestId) {

  fetch(`http://localhost:5000/api/requests/${requestId}`, {
    method: 'DELETE'
  })
  .then(response => response.json())
  .then(data => {
    console.log(data.message);
    render('requests');
  })
  .catch(error => console.error('ุฎุทุฃ ูุดุงูุฏุฉ ุงูุทูุจ:', error));
}
  </script>
<script src="ad.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
<script>
  window.onload = () => {
    function checkAuth() {
      const token = localStorage.getItem('token');

      if (!token) {
        window.location.href = 'login-admin.html'; // ุฅุนุงุฏุฉ ุงูุชูุฌูู ุฅุฐุง ูู ููู ููุงู ุชููู
        return;
      }

      try {
        // ูู ุงูุชููู ูุงูุชุญูู ูู ุงูุฏูุฑ
        const decoded = jwt_decode(token);
        if (decoded.role !== 'admin') {
          window.location.href = 'citizen-wallet.html'; // ุฅุนุงุฏุฉ ุงูุชูุฌูู ุฅูู ูุญูุธุฉ ุงูููุงุทู ุฅุฐุง ูู ููู "admin"
          return;
        }

        // ุงุณุชุฎุฑุงุฌ ุงุณู ุงููุณุคูู ูู ุงูุชููู ูุนุฑุถู
        const adminName = decoded.fullName ;
        document.getElementById('adminName').textContent = adminName;

      } catch (error) {
        console.error('ุฎุทุฃ ูู ูู ุงูุชููู:', error);
        localStorage.removeItem('token');
        localStorage.removeItem('userId');
        window.location.href = 'login-admin.html'; // ุฅุนุงุฏุฉ ุงูุชูุฌูู ุฅุฐุง ูุงู ููุงู ุฎุทุฃ ูู ุงูุชููู
      }
    }
    checkAuth();
    setInterval(checkAuth, 3000);
  };
  // ุงูุชุญูู ุฅุฐุง ุชู ุญุฐู ุงูุชููู ูู localStorage ูู ุฃู ุชุจููุจ ุขุฎุฑ
  window.addEventListener("storage", (event) => {
    if (event.key === "token" && !event.newValue) {
      window.location.href = "login-admin.html"; // ุฅุนุงุฏุฉ ุงูุชูุฌูู ุฅุฐุง ุชู ุญุฐู ุงูุชููู
    }
  });
</script>
</body>
</html>
